# Lab 08 - Jinja `include` and `import` statements

Goals of this lab:

- Practice using include statement.
- Practice using import statement.

## Task 01

> Resources for this task:
>  - [Jinja2 include](https://jinja2docs.readthedocs.io/en/stable/templates.html#include)

### Step 1

You will be working with variables defined in the `python/vars/lab08-task1.yml` file and the initial template defined in the `python/vars/lab08-task1-init.j2` file.

You can open these to familiarize yourself with their contents.

### Step 2

Split the template from the `python/vars/lab08-task1-init.j2` file into multiple smaller templates each rendering section of the initial template.

Use the below section names:

- aaa
- banner
- bgp
- dns
- general
- interfaces
- ntp
- prefix_lists

Name each of your templates after the section name and place them in the `templates/sections` directory.

For example, for section `dns` you would create the `templates/sections/dns.j2` template. This should contain a template rendering DNS related configuration.

Once you created your section templates, create a template named `lab08-task1-final.j2`. This template should only contain references to section templates and nothing else.

Make sure that the config generated by `lab08-task1-final.j2` matches the order of the config generated by the `lab08-task1-init.j2` template.


<details>
  <summary><b>Output to match</b></summary>

```
hostname rtr-edge-ams-01
!
aaa new-model
aaa authentication login default group tacacs+ local enable
aaa authentication enable default group tacacs+ enable
aaa authorization exec default group tacacs+ local if-authenticated
aaa authorization commands 1 default group tacacs+ if-authenticated
aaa authorization commands 15 default group tacacs+ if-authenticated
aaa accounting exec default start-stop group tacacs+
aaa accounting commands 1 default start-stop group tacacs+
aaa accounting commands 15 default start-stop group tacacs+
aaa accounting network default start-stop group tacacs+
aaa accounting connection default start-stop group tacacs+
aaa accounting system default start-stop group tacacs+
!
banner motd ^
=============================================
|   This device is property of CorpCo       |
|   Unauthorized access is unauthorized     |
|  Only access it if you have access rights |
|  Access attempts and commands are logged  |
=============================================
^
!
no ip domain lookup
ip domain name local.lab
ip name-server 8.8.8.8
ip name-server 8.8.4.4
!
ntp server 1.127.0.1 prefer
ntp server 1.200.0.127
!
interface GigabitEthernet1
 WAN to US
 10.56.0.0/31
interface GigabitEthernet2
 WAN to US
 10.56.0.0/31
interface GigabitEthernet3
 Uplink to FW
 10.99.15.250/31
interface GigabitEthernet4
 Corvil monitoring
 10.255.0.1/30
!
ip prefix-list PL_WAN_US_IN
 permit 0.0.0.0/0 le 32
ip prefix-list PL_WAN_US_OUT
 permit 10.0.1.0/16
 permit 10.0.2.0/16
ip prefix-list PL_WAN_JPN_IN
 permit 0.0.0.0/0 le 32
ip prefix-list RM_WAN_JPN_OUT
 permit 10.5.1.0/16
 permit 10.5.2.0/16
!
router bgp 65005
bgp router-id 1.1.1.1
bgp log-neighbor-changes 
 address-family ipv4 unicast
 neighbor 10.56.0.1/31 remote-as 65007
 neighbor 10.56.0.1/31 description rtr-edge-ny-01
 neighbor 10.56.0.1/31 route-map RM_WAN_US_IN in
 neighbor 10.56.0.1/31 route-map RM_WAN_US_OUT out
 neighbor 10.56.0.1/31 route-reflector-client
 neighbor 10.56.0.1/31 activate
 address-family ipv4 vrf ASIA-SEGMENT
 neighbor 10.89.5.3/31 remote-as 65034
 neighbor 10.89.5.3/31 description rtr-edge-ty-01
 neighbor 10.89.5.3/31 route-map RM_WAN_JPN_IN in
 neighbor 10.89.5.3/31 route-map RM_WAN_JPN_OUT out
 neighbor 10.89.5.3/31 activate
 neighbor 10.89.5.3/31 send-community both
 ```
</details>

### Step 3

Run the below command to test your template.

```
./j2_render.py -t lab08-task1-final.j2 -d lab08-task1.yml -trim
```

<details>
  <summary>Reveal Answer</summary>

You should split the original template into multiple chunks and move them to section templates.

Each section template will contain part of the original template related to the given config element.

Once all template chunks are in place combine them by using `{% include 'template_path' %}` expression.

```
{% include 'sections/general.j2' %}
{% include 'sections/aaa.j2' %}
{% include 'sections/dns.j2' %}
{% include 'sections/ntp.j2' %}
{% include 'sections/interfaces.j2' %}
{% include 'sections/prefix_lists.j2' %}
{% include 'sections/bgp.j2' %}
```

</details>

## Task 02

> Resources for this task:
>  - [Jinja2 include](https://jinja2docs.readthedocs.io/en/stable/templates.html#include)

### Step 1

You will be working with variables defined in the `python/vars/lab08-task2.yml` file and template defined in the `python/templates/lab08-task2.j2` file.

You can open these to familiarize yourself with their contents.

### Step 2

Template `python/vars/lab08-task2.j2` uses section templates created in the Task 01.

You should now make a copy of the `bgp.j2` template you created in Task 01 and name this copy `bgp_v2.j2`.

Your task is to move duplicated neighbor configuration lines in `bgp_v2.j2` to another template called `bgp_neighbor.j2` in the `templates/sections` directory. Template `bgp_v2.j2` should use this sub-template to generate a neighbor configuration.

Your final output should match the output from Task 01.

### Step 3

Run the below command to test your template.

```
./j2_render.py -d lab08-task2.yml -t lab08-task2.j2 -trim
```

<details>
  <summary>Reveal Answer</summary>

You should move the duplicated lines, generating BGP neighbor config, from `bgp_v2.j2` to `bgp_neighbor.j2` template.

```
  neighbor {{ neighbor['ip'] }} remote-as {{ neighbor['as_no'] }}
  neighbor {{ neighbor['ip'] }} description {{ neighbor['description'] }}
  neighbor {{ neighbor['ip'] }} route-map {{ neighbor['rm_in'] }} in
  neighbor {{ neighbor['ip'] }} route-map {{ neighbor['rm_out'] }} out
{%  if 'send_community' in neighbor['properties'] %}
  neighbor {{ neighbor['ip'] }} send-community both
{% endif %}
{%   if 'rr_client' in neighbor['properties'] %}
  neighbor {{ neighbor['ip'] }} route-reflector-client
{%   endif %}
  neighbor {{ neighbor['ip'] }} activate
```

Lines removed from `bgp_v2.j2` should be replaced with `{% include 'sections/bgp_neighbor.j2' %}` line followed by an empty new line. A new line is needed to ensure correct formatting.

```
!
router bgp {{ bgp['as_no'] }}
 bgp router-id {{ bgp['rid'] }}
 bgp log-neighbor-changes 
{% for neighbor in bgp['neighbors'] %}
{%  if neighbor['vrf'] is defined %}
 address-family ipv4 vrf {{ neighbor['vrf'] }}
{% include 'sections/bgp_neighbor.j2' %}

{%  else %}
 address-family ipv4 unicast
{% include 'sections/bgp_neighbor.j2' %}

{%  endif %}
{% endfor %}
```

</details>

## Task 03

> Resources for this task:
>  - [Jinja2 import](https://jinja2docs.readthedocs.io/en/stable/templates.html#import)
>  - [Jinja2 macros](https://jinja2docs.readthedocs.io/en/stable/templates.html#macros)

### Step 1

You will be working with variables defined in the `python/vars/lab08-task3.yml` file and macros defined in the `python/templates/macros/ip_net_format.j2` file.

You can open these to familiarize yourself with their contents.

### Step 2

Create template named `lab08-task3.j2` in `python/templates` dir.

In your template use macros defined in the `python/templates/macros/ip_net_format.j2` to generate output matching the below one:

**Output to match**
```
Networks in "network wildcard" format:
10.5.0.0 0.0.1.255
10.7.1.128 0.0.0.127
10.11.4.192 0.0.0.63

Networks in "network netmask" format:
10.5.0.0 255.255.254.0
10.7.1.128 255.255.255.128
10.11.4.192 255.255.255.192

Networks in "network/pfxlen" format:
10.5.0.0/23
10.7.1.128/25
10.11.4.192/26
```

Your macros should all belong to the namespace; you can use whatever name you wish for the namespace.

### Step 3

Run the below command to test your template.

```
./j2_render.py -t lab08-task3.j2 -d lab08-task3.yml -trim
```

<details>
  <summary>Reveal Answer</summary>

You should import macros in `ip_net_format.j2` file by using `{% import %}` statement and specifying path relative to `templates` directory: `macros/ip_net_format.j2`.

In your import statement, you should use `as namespace_name` syntax to import macros from the file into the namespace named `namespace_name`.

To generate the desired output, you should create `for` loops. Inside `for` loops you should apply the corresponding macro by referring to the namespace and the macro name.

```
{% import 'macros/ip_net_format.j2' as ip_macro %}

Networks in "network wildcard" format:
{% for net in networks %}
{{ ip_macro.network_w_wildcard(net['prefix']) }}
{% endfor %}

Networks in "network netmask" format:
{% for net in networks %}
{{ ip_macro.network_w_netmask(net['prefix']) }}
{% endfor %}

Networks in "network/pfxlen" format:
{% for net in networks %}
{{ ip_macro.network_w_pfxlen(net['prefix']) }}
{% endfor %}
```

</details>

### Step 4

Modify template `lab08-task3.j2`, which you created in this task, to include macros individually. You should no longer use the namespace when using macros.

### Step 5

Run the below command to test your template.

```
./j2_render.py -t lab08-task3.j2 -d lab08-task3.yml -trim
```

<details>
  <summary>Reveal Answer</summary>

You should import macros individually from the `ip_net_format.j2` file by using `{% from 'macros_file' import macro1, macro2 %}` statement. 

In your import statement, you should list the names of the macros you are importing.

To generate the desired output, you should create `for` loops. Inside `for` loops you should apply the corresponding macro by referring to the macro name. We're not using namespaces here.

```
{% from 'macros/ip_net_format.j2' import network_w_wildcard, network_w_netmask, network_w_pfxlen  %}

Networks in "network wildcard" format:
{% for net in networks %}
{{ network_w_wildcard(net['prefix']) }}
{% endfor %}

Networks in "network netmask" format:
{% for net in networks %}
{{ network_w_netmask(net['prefix']) }}
{% endfor %}

Networks in "network/pfxlen" format:
{% for net in networks %}
{{ network_w_pfxlen(net['prefix']) }}
{% endfor %}
```

</details>