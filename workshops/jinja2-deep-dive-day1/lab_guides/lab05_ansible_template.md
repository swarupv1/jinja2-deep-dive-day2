# Lab 05 - Jinja template rendering with Ansible

Goals of this lab:

- Practice using the `template` module for rendering templates.
- Practice whitespace control when rendering templates with Ansible.

## Task 01

### Step 1

Change into the `ansible` directory and create `output` directory:

```
mkdir output
```

### Step 2

Copy the data and template from Lab 01, task 1 into `templates` and `vars` directories, respectively.

Your directories should look like so:

```
tree vars/
vars/
└── lab01-task1.yml

tree templates/
templates/
└── lab01-task1.j2
```

### Step 3

Copy the below Ansible Playbook into the file called `pb_template_render.yml` in the `ansible` directory.

```ansible
---
- name: "PLAY 1: TEMPLATE RENDERING"
  hosts: "localhost"
  connection: "local"
  gather_facts: false

  vars:
    data_file: "lab01-task1.yml"
    template_file: "lab01-task1.j2"
    dest_file: "lab01-task1.txt"

  tasks:
    - name: "TASK 1: LOAD VARIABLES"
      include_vars:
        file: "vars/{{ data_file }}"

    - name: "TASK 2: RENDER TEMPLATE"
      template:
        src: "{{ template_file }}"
        dest: "output/{{ dest_file }}"

```

### Step 4

Execute the playbook using the below command:

```ansible-playbook pb_template_render.yml```

### Step 5

Investigate output file and confirm template rendered correctly.

This is a simple example of using the Ansible `template` module to render the Jinja template.

As a minimum `template` expects `src` and `dest` arguments. Source templates are read from the local `templates` directory by default.


## Task 02

### Step 1

Create data file `lab05-task2.yml` in `./vars`. Copy the below content into it:

```yaml
---
server_name: machineLearning-cluster01-ch

algo: neural_network
```

Create template file `lab05-task2.j2` in `./templates`. Copy the below content into it:

```
Machine Learning cluster: {{ server_name }}
Selected algorithm: {{ algo }
Processing power: {{ cluster_mflops }}
```

### Step 2

Change the values of `data_file`, `template_file` and `dest_file` to match the below ones:

```yaml
  vars:
    data_file: "lab05-task2.yml"
    template_file: "lab05-task2.j2"
    dest_file: "lab05-task2.txt"
```

### Step 3

Execute the playbook using the below command:

```ansible-playbook pb_template_render.yml```

You should get an error stating that the variable `cluster_mflops` is undefined.

Ansible will raise an error by default when encountering undefined variables.

This behavior is different from the `jinja2` package in Python where you had to explicitly ask for errors to be raised for undefined variables.

## Task 03

### Step 1

Files `vars/lab05-task3.yml` and `templates/lab05-task3.j2` were created for you. You can review their contents.

### Step 2

Change the values of `data_file`, `template_file` and `dest_file` in `pb_template_render.yml` to match the below ones:

```yaml
  vars:
    data_file: "lab05-task3.yml"
    template_file: "lab05-task3.j2"
    dest_file: "lab05-task3.txt"
```

### Step 3

Execute the playbook using the below command:

```ansible-playbook pb_template_render.yml```

### Step 4

Investigate the output of the rendered template in the `./output` directory.

You should notice there are no new lines generated by Jinja blocks. There are still however indentation issues resulting from the whitespaces preceding Jinja blocks.

Ansible by default enables the `trim` option that you had to explicitly configure in Python with the `jinja2` package.

However, `lstrip_blocks` is set to `False` by default in Ansible, just as is the case with Python `jinja2` package.

## Task 04

### Step 1

Add the below line to the very top of the `lab05-task3.j2` template:

```
#jinja2: lstrip_blocks: True
```

### Step 2

Execute the playbook using the below command:

```ansible-playbook pb_template_render.yml```

### Step 3

Investigate the output of the rendered template in the `./output` directory.

The output should not have any extra newlines or spaces. The below directive placed at the top of the template tells Ansible to strip whitespaces preceding Jinja blocks.

```
#jinja2: lstrip_blocks: True
```

The downside of this directive is that you need to include it in each of the templates where you want line stripping to be enforced.

## Task 05

### Task 1

Remove the line at the very top of the `lab05-task3.j2` template that you added in the previous task.

```
#jinja2: lstrip_blocks: True
```

### Step 2

Add `lstrip_blocks: false` argument to the task with `template` module. 

```yaml
    - name: "TASK 2: RENDER TEMPLATE"
      template:
        src: "{{ template_file }}"
        dest: "output/{{ dest_file }}"
        lstrip_blocks: true
```

### Step 3

Execute the playbook using the below command:

```ansible-playbook pb_template_render.yml```

### Step 4

Investigate the output of the rendered template in the `./output` directory.

The output of the file should be unchanged compared to the previous task.

You removed the `lstrip_blocks` directive from the top of the template. Instead, you added the `lstrip_blocks: true` argument at a `template` task level.

This argument tells the `template` module to remove spaces preceding Jinja blocks. Ansible will apply this behavior to all templates rendered in this task.
